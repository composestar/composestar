<?xml version="1.0" encoding="UTF-8"?>
<project name="ComposeStar/StarLight/Setup" default="build" xmlns:dn="antlib:org.apache.ant.dotnet">

	<condition property="build.core" value="${basedir}${file.separator}..${file.separator}..${file.separator}Core">
		<and>
			<not>
				<isset property="build.core" />
			</not>
			<available file="${basedir}${file.separator}..${file.separator}..${file.separator}Core${file.separator}common.xml" />
		</and>
	</condition>
	<import file="${build.core}/common.xml" />

	<description>Compose*/StarLight Setup. Generates the MSI installer.</description>

	<target name="clean" depends="init" description="Clean compile results">
		<echo level="info">Cleaning WIX object files</echo>
		<delete>
			<fileset dir="." includes="**/*.wixobj" />
			<fileset dir="Releases" includes="**/*.msi" />
			<fileset dir="Releases" includes="**/*.sha1" />
		</delete>
	</target>

	<target name="local_init" depends="init">

		<!-- WIX -->
		<property name="path.wix" value="${build.starlight}${file.separator}Development${file.separator}Wix${file.separator}" />

		<property name="MSBuildTasks.dir" location="..${file.separator}Source${file.separator}VSIntegration${file.separator}MSBuildTasks" />
		<property name="VSProject.dir" location="..${file.separator}Source${file.separator}VSIntegration${file.separator}VisualStudio.Project" />
		<property name="VSLang.dir" location="..${file.separator}Source${file.separator}VSIntegration${file.separator}VisualStudio.LanguageServices" />
		<property name="WeaveStrategy.dir" location="..${file.separator}Source${file.separator}StarLight.Weaving.BuiltIn" />
		<property name="wixsource.path" value="${basedir}${file.separator}WixStarLight${file.separator}" />
		<property name="msi.file" value="${build.starlight}${file.separator}Setup${file.separator}Releases${file.separator}StarLight_${version.starlight}.msi" />
		<property name="wixtemp.path" value="${build.starlight}${file.separator}Setup${file.separator}" />
		
		<property name="VSTools.path" value="C:\Program Files\Microsoft Visual Studio 8\Common7\Tools" />
				
		<path id="VSSDK.path.set">
			<dirset dir="C:\Program Files\Visual Studio 2005 SDK">
  			<include name="*\VisualStudioIntegration\Tools\Bin" />
			</dirset>
		</path>
		<property name="VSSDK.path" refid="VSSDK.path.set" />
	</target>

	<target name="build" depends="local_init,clean,compile_sources" description="Compile the installer files">
		<copy todir="installed">
			<fileset file="${basedir}/../Source/Compiletime/src/INCREconfig.xml" />
		</copy>
		<echo level="info">Building MSI file using WIX</echo>
		<echo level="info">Running Candle for preprocessing</echo>
		<exec executable="${VSTools.path}\uuidgen.exe" outputproperty="starlight.uuid.product" />
		<exec executable="${VSTools.path}\uuidgen.exe" outputproperty="starlight.uuid.package" />
		<echo level="info">ProductId = ${starlight.uuid.product}; PackageId = ${starlight.uuid.package}</echo>
		<exec executable="${path.wix}candle.exe" failonerror="true">
			<arg value="-I${wixsource.path}" />
			<arg value="-dProductVersion=${version.starlight}" />
			<arg value="-dProductId=${starlight.uuid.product}" />
			<arg value="-dPackageId=${starlight.uuid.package}" />
			<arg value="-dVariablesFile=${wixsource.path}Variables.wxi" />			
			<arg value="${wixsource.path}WixStarLight.wxs" />
			<arg value="${wixsource.path}WixProlog.wxs" />
			<arg value="${wixsource.path}WixDocuments.wxs" />
			<arg value="${wixsource.path}WixXmlBeans.wxs" />
			<arg value="${wixsource.path}WixLibs.wxs" />
			<arg value="${wixsource.path}WixGroove.wxs" />
			<arg value="${wixsource.path}WixAntlr.wxs" />
			<arg value="${wixsource.path}MSBuild.wxs" />
			<arg value="${wixsource.path}VSIntegration.wxs" />
			<arg value="${wixsource.path}CoreElements.wxs" />
			<arg value="-nologo" />
		</exec>
		<echo level="info">Running Light for MSI generation to ${msi.file}</echo>
		<exec executable="${path.wix}light.exe" failonerror="true">
			<arg value="-out" />
			<arg value="${msi.file}" />
			<arg value="-b ${wixtemp.path}" />
			<arg value="WixStarLight.wixobj" />
			<arg value="WixProlog.wixobj" />
			<arg value="WixLibs.wixobj" />
			<arg value="WixDocuments.wixobj" />
			<arg value="WixXmlBeans.wixobj" />
			<arg value="WixGroove.wixobj" />
			<arg value="WixAntlr.wixobj" />
			<arg value="MSBuild.wixobj" />
			<arg value="VSIntegration.wixobj" />
			<arg value="CoreElements.wixobj" />
			<arg value="${wixsource.path}wixui.wixlib" />
			<arg value="-loc ${wixsource.path}WixUI_en-us.wxl" />
			<arg value="-nologo" />
		</exec>
		<checksum file="${msi.file}" forceOverwrite="yes" algorithm="sha1" format="MD5SUM" />
	</target>

	<target name="compile_sources" depends="local_init">
		<echo level="info">Compiling .NET sources in release mode</echo>
		<msbuild solution="${MSBuildTasks.dir}${file.separator}StarLight.MSBuild.Tasks.csproj" target="build" config="release" />
		<msbuild solution="${VSProject.dir}${file.separator}StarLight.VisualStudio.Project.csproj" target="build" config="release" />
		<msbuild solution="${VSLang.dir}${file.separator}StarLight.VisualStudio.LanguageServices.csproj" target="build" config="release" />
		<msbuild solution="${WeaveStrategy.dir}${file.separator}StarLight.Weaving.BuiltIn.csproj" target="build" config="release" />
		
		<exec executable="regpkg.exe" failonerror="true" resolveexecutable="true" searchpath="true">
			<env key="PATH" path="${env.PATH}:${VSSDK.path}"/>
			<arg value="/codebase" />
			<arg value="/root:Software\Microsoft\VisualStudio\8.0" />
			<arg value="/wixfile:WixStarLight\StarLight.LanguageService.generated.wxi" />
			<arg value="..\Source\VSIntegration\VisualStudio.Project\bin\Release\Composestar.StarLight.VisualStudio.LanguageServices.dll" />
		</exec>
		<exec executable="regpkg.exe" failonerror="true" resolveexecutable="true" searchpath="true">
			<env key="PATH" path="${env.PATH}:${VSSDK.path}"/>
			<arg value="/codebase" />
			<arg value="/root:Software\Microsoft\VisualStudio\8.0" />
			<arg value="/wixfile:WixStarLight\StarLightProject.generated.wxi" />
			<arg value="..\Source\VSIntegration\VisualStudio.Project\bin\Release\Composestar.StarLight.VisualStudio.Project.dll" />
		</exec>
	</target>

</project>

