<?xml version="1.0" encoding="UTF-8"?>
<project name="ComposeStar/StarLight" default="build">

	<condition property="build.core" value="${basedir}/../Core">
		<and>
			<not><isset property="build.core"/></not>
			<available file="${basedir}/../Core/common.xml" />
		</and>
	</condition>
	<import file="${build.core}/common.xml" />

	<echo>Processing: ${ant.project.name} ...</echo>
	<description>The StarLight implementation of Compose*</description>

	<property name="out.qa.starlight"    value="QualityAssurance"/>
	<property name="out.fxcop.starlight" value="QualityAssurance"/>

	<property name="MSBuildTasks.dir" location="Source/VSIntegration/MSBuildTasks"/>

	<!-- clean -->
	
	<target name="clean" depends="init" description="Cleanup the result of compilations">
		<delete dir="${out.qa.starlight}" />
		<delete dir="${out.fxcop.starlight}" />
	  <delete file="Documentation\ComposeStar-StarLight.chm" />
	  <delete file="Documentation\LastBuild.log" />
		<ant target="clean" dir="Source/Compiletime" />
		<ant target="clean" dir="Source/StarLight.Weaving.BuildIn" />
		<ant target="clean" dir="Source/VSIntegration/MSBuildTasks" />
		<ant target="clean" dir="Source/VSIntegration/VisualStudio.Project" />
	</target>

	<!-- build -->
	
	<target name="build" description="Build the StarLight implementation of Compose*">
		<antcall target="build_compiletime"/>
		<antcall target="build_msbuild"/>
		<antcall target="build_vs"/>
		<antcall target="build_ws"/>
	</target>

	<target name="build_compiletime" description="Build Compose* StarLight Compiletime">
		<ant target="build" dir="Source/Compiletime" />
	</target>
	
	<target name="build_msbuild" description="Build Compose* StarLight MSBuild tasks">
		<ant target="build" dir="Source/VSIntegration/MSBuildTasks" />
	</target>
	
	<target name="build_vs" description="Build Compose* StarLight VS Integration">
		<ant target="build" dir="Source/VSIntegration/VisualStudio.Project" />
	</target>
	
	<target name="build_ws" description="Build Compose* StarLight WeaveStrategy">
		<ant target="build" dir="Source/StarLight.Weaving.BuildIn" />
	</target>

	<!-- install -->

	<target name="install" depends="build" description="Install the StarLight implementation of Compose*">
		<!-- todo -->
	</target>

	<!-- publish -->

	<target name="publish" depends="build" description="Create the StarLight installer">
		<ant target="publish" dir="${build.starlight}/Setup"/>
	</target>

	<!-- QA -->
	
	<target name="init_qa" depends="init">
		<mkdir dir="${out.qa.starlight}" />
	</target>
	
	<target name="findbugs" depends="init_qa" description="Execute FindBugs">
		<findbugs home="${bin.findbugs}" output="xml:withMessages" effort="${findbugs.effort}" reportLevel="${findbugs.reportLevel}" outputFile="${out.qa.starlight}/findbugs-result.xml" excludeFilter="${bin.findbugs}/exclude.xml" jvmargs="${findbugs.jvmargs}">
			<class location="${build.starlight}/source/Compiletime/${out.build}" />
			<sourcePath path="${build.starlight}/source/Compiletime/src" />
			<auxClasspath refid="lib.core" />
			<auxClasspath>
				<pathelement path="${build.core}/Compiletime/${out.jar.core}" />
				<pathelement path="${build.starlight}/libraries/xmltypes.jar" />
			</auxClasspath>
		</findbugs>
		<xslt in="${out.qa.starlight}/findbugs-result.xml" out="${out.qa.starlight}/findbugs-result.html" style="${findbugs.style}" />
	</target>
	
	<target name="checkstyle" depends="init_qa" description="Run CheckStyle code proof reading">
		<checkstyle config="${bin.checkstyle}/star_checks.xml" failOnViolation="false" classpathref="lib.starlight">
			<formatter type="xml" toFile="${out.qa.starlight}/checkstyle-result.xml" />
			<property key="config_loc" value="${bin.checkstyle}" />
			<FileSet dir="${build.starlight}/source/Compiletime/src">
				<include name="**/*.java" />
				<exclude name="Composestar/DotNET/DUMMER/JSharpLexer.java" />
				<exclude name="Composestar/DotNET/DUMMER/JSharpRecognizer.java" />
				<exclude name="Composestar/DotNET/DUMMER/JSharpTokenTypes.java" />
			</FileSet>
		</checkstyle>
		<xslt in="${out.qa.starlight}/checkstyle-result.xml" out="${out.qa.starlight}/checkstyle-result.html" style="${checkstyle.style}" />
	</target>
	
	<target name="build_codeanalysis" description="Build .net projects for code analysis">
		<msbuild solution="${MSBuildTasks.dir}/StarLight.MSBuild.Tasks.csproj" target="build" config="Debug" />
	</target>
	
	<target name="fxcop_init" >
		<mkdir dir="${out.fxcop.starlight}" />
	</target>
	
	<target name="fxcop" depends="build_codeanalysis,fxcop_init" description="Build all the outputs and run fxcop">
		<fxcop reportfile="${out.fxcop.starlight}/fxcop.txt"
		       files="${MSBuildTasks.dir}/Bin/Debug/Composestar*.dll"/>
	</target>

	<!-- documentation -->
	
	<target name="documentation" description="Create StarLight documentation">
		
		<!-- Build dependencies -->
		<msbuild solution="Libraries\cecil\Mono.Cecil.csproj" target="build" config="release" />
		<msbuild solution="Source\CoreServices\StarLight.CoreServices.csproj" target="build" config="release" />
		<msbuild solution="Source\Repository\DataStoreContainer.csproj" target="build" config="release" />
		<msbuild solution="Source\StarLightEntities\StarLightEntities.csproj" target="build" config="release" />
	
		<!-- Build assemblies -->
		<msbuild solution="Source\ContextInfo\StarLight.ContextInfo.csproj" target="build" config="release" />
		<msbuild solution="Source\StarLight.Filters\StarLight.Filters.csproj" target="build" config="release" />
		<msbuild solution="Source\StarLight.Weaving\StarLight.Weaving.csproj" target="build" config="release" />
		<msbuild solution="Source\Utilities\Cecil\CecilUtilities.csproj" target="build" config="release" />
	
		<!-- Run Sandcastle -->
		<exec dir="${build.starlight}${file.separator}documentation" executable="${bin.sandcastle}">
			<arg value="${build.starlight}${file.separator}documentation${file.separator}SandcastleHelpStarLight.shfb"/>
		</exec>
		
	</target>

	<target name="qa_starlight" description="Execute Quality Assurance tasks">
		<antcall target="fxcop_starlight" />
		<antcall target="findbugs_starlight" />
		<antcall target="checkstyle_starlight" />
	</target>
	
	<target name="fxcop_starlight" depends="init" if="enabled.starlight">
		<ant target="fxcop" dir="${build.starlight}" />
	</target>
	
	<target name="findbugs_starlight" depends="init" if="enabled.starlight">
		<ant target="findbugs" dir="${build.starlight}" />
	</target>

	<target name="checkstyle_starlight" depends="init" if="enabled.starlight">
		<ant target="checkstyle" dir="${build.starlight}" />
	</target>


	<!-- fancy menu -->

	<target name="select" depends="init">	
		<taskdef resource="com/sardak/antform/taskdefs.properties" classpath="${basedir}/Ant/lib/antform.jar"/>
		<antmenu image="images${file.separator}logos${file.separator}logofull.png">
		
			<antMenuItem name="StarLight" >
				<antMenuItem name="Clean"  target="clean"/>
				<antMenuItem name="Build">
					<antMenuItem name="Build all"     target="build"/>
					<antMenuItem name="Rebuild all"   target="rebuild"/>
					<antMenuItem name="Core"          target="build_core"/>
					<antMenuItem name="Compiletime"   target="build_compiletime"/>
					<antMenuItem name="MSBuildTasks"  target="build_msbuild"/>
					<antMenuItem name="VSIntegration" target="build_vs"/>
					<antMenuItem name="WeaveStrategy" target="build_ws"/>
				</antMenuItem>
				<antMenuItem name="Install">
					<antMenuItem name="Install"       target="install_starlight"/>
					<antMenuItem name="Uninstall"     target="uninstall_starlight"/>
				</antMenuItem>
				<antMenuItem name="Publish">
					<antMenuItem name="StarLight"     target="publish_starlight"/>
				</antMenuItem>
				<antMenuItem name="Run tests"><!-- todo -->
					<antMenuItem name="All"           target="test"/>
					<antMenuItem name="NUnit"         target="test_nunit"/>
				</antMenuItem>
				<antMenuItem name="QA">
					<antMenuItem name="All"           target="qa_starlight"/>
					<antMenuItem name="FxCop"         target="fxcop_starlight"/>
					<antMenuItem name="FindBugs"      target="findbugs_starlight"/>
					<antMenuItem name="CheckStyle"    target="checkstyle_starlight"/>
				</antMenuItem>
				<antMenuItem name="Docs">
					<antMenuItem name="StarLight"     target="documentation_starlight"/>
				</antMenuItem>
			</antMenuItem>
			
			<link label="Build" target="build"/>
			<link label="Rebuild" target="rebuild"/>
			<link label="Clean install" target="cleaninstall"/>
			<link label="Quality Assurance" target="qa_starlight"/>
			<separator/>
			<link label="Cancel" target="cancel"/>
		
		</antmenu>
	</target>

</project>
