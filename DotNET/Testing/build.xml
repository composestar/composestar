<project name="Composestar/DotNET/Testing" default="test" xmlns:cs="antlib:Composestar">

	<description>
	Run the Compose* SystemTest for DotNET
	</description>

	<property name="build.core" location="../../Core"/>
	<import file="${build.core}/common.xml"/>

	<target name="init_local" depends="init">
		<property name="test.mode" value="VS2003"/>
		<property name="INCRE.config" value="INCREconfig.xml"/>
		
		<condition property="test.mode.2003">
			<equals arg1="${test.mode}" arg2="VS2003"/>
		</condition>
		
		<condition property="test.mode.2005">
			<equals arg1="${test.mode}" arg2="VS2005"/>
		</condition>
	</target>

	<target name="clean" depends="init">
		<delete>
			<fileset dir="${basedir}">
				<include name="TEST-*.xml" />
			</fileset>
		</delete>
		<!-- delete /obj dirs -->
		<delete includeEmptyDirs="true">
			<FileSet dir="${build.dotnet}/Examples">
				<include name="**/obj/"/>
				<exclude name="AOSD2006Demo/EncryptionFilter/**"/>
				<exclude name="AOSD2006Demo/ProtocolLib/**"/>
			</FileSet>
		</delete>
		<!-- delete generated files in /bin -->
		<!-- (cannot delete the whole dir because of correct.txt files and such) -->
		<delete includeEmptyDirs="true">
			<FileSet dir="${build.dotnet}/Examples">
				<include name="**/bin/**/*.exe"/>
				<include name="**/bin/**/*.dll"/>
				<include name="**/bin/**/*.pdb"/>
				<include name="**/bin/**/repository.xml*"/>
				<include name="**/bin/**/runlog.txt"/>
				<exclude name="AOSD2006Demo/EncryptionFilter/**"/>
				<exclude name="AOSD2006Demo/ProtocolLib/**"/>
				<exclude name="Jukebox/jukeboxframe/**"/>
				<exclude name="DesignPatterns/Annotations/**"/>
			</FileSet>
		</delete>
		<!-- delete /analyses dir -->
		<delete includeEmptyDirs="true">
			<FileSet dir="${build.dotnet}/Examples">
				<include name="**/analyses/"/>
			</FileSet>
		</delete>
		<!-- delete compile history -->
		<delete includeEmptyDirs="true">
			<FileSet dir="${build.dotnet}/Examples">
				<include name="**/ComposestarHistory.cchz"/>
			</FileSet>
		</delete>
	</target>
	
	<target name="build"/>

	<target name="test" depends="test_comp,test_exec,test_incre" description="Execute the DotNET system test." />
	
	<!-- generate BuildConfiguration.xml files -->

	<target name="test_bgen">
		<antcall target="test_bgen_2003"/>
		<antcall target="test_bgen_2005"/>
	</target>

	<target name="test_bgen_2003" depends="init_local" if="test.mode.2003">
		<cs:dn_bgen composestarBase="${composestar.installdir}"
		               antHelperPath="${build.core}/Development"		          
		               xslt="${basedir}/AntSystemTest/genBuildConfig.xslt">
			<FileSet dir="${build.dotnet}/Examples">
				<include name="**/*.vjsproj"/>
				<include name="**/*.csproj"/>
				<exclude name="AOSD2006Demo/EncryptionFilter/*"/>
				<exclude name="AOSD2006Demo/ProtocolLib/*"/>
				<exclude name="DesignPatterns/Annotations/*"/>
				<exclude name="Jukebox/jukeboxframe/*"/>
				<exclude name="Rot13/Rot13Filter/*"/>
			</FileSet>
			<Modules>
				<INCRE config="${INCRE.config}" />
				<INCRESerializer force="true" />
			</Modules>
		</cs:dn_bgen>
	</target>
	
	<target name="test_bgen_2005" depends="init_local,test_convert" if="test.mode.2005">
		<cs:dn_msbatch target="ComposeStarGen">
			<FileSet dir="${build.dotnet}/Examples">
				<include name="**/*.cpsproj"/>
				<exclude name="AOSD2006Demo/EncryptionFilter/*"/>
				<exclude name="AOSD2006Demo/ProtocolLib/*"/>
				<exclude name="DesignPatterns/Annotations/*"/>
				<exclude name="Jukebox/jukeboxframe/*"/>
				<exclude name="Rot13/Rot13Filter/*"/>
			</FileSet>
		</cs:dn_msbatch>
	</target>

	<!-- compiles projects (requires BuildConfiguration.xml to be present) -->

	<target name="test_comp" depends="init_local,test_bgen">
		<cs:dn_comp composestarBase="${composestar.installdir}" resultOutput="${basedir}/TEST-Compilation.xml">
			<FileSet dir="${build.dotnet}/Examples">
				<include name="**/BuildConfiguration.xml"/>
				<exclude name="AOSD2006Demo/EncryptionFilter/*"/>
				<exclude name="AOSD2006Demo/ProtocolLib/*"/>
				<exclude name="DesignPatterns/Annotations/*"/>
				<exclude name="DesignPatterns/Implementations/Composite/*"/>
				<exclude name="Jukebox/jukeboxframe/*"/>
				<exclude name="Rot13/Rot13Filter/*"/>
			</FileSet>
		</cs:dn_comp>
	</target>

	<!-- executes tests -->
	
	<target name="test_exec" depends="init_local">
		<cs:test resultOutput="${basedir}/TEST-Execution.xml">
			<commandline>
				<argument value="-systemtest" />
			</commandline>
			<FileSet dir="${build.dotnet}/Examples">
				<!-- output not always correct but should be -->
				<!--
				<include name="InventoryTwo/bin/InventoryTwo.Example.exe"/>
				-->
				
				<!-- plaged with deadlocks -->
				<!--				
				<include name="Inventory/bin/ExampleAOP.Example.exe"/>
				<include name="Rot13/bin/Rot13Filter.Rot13Example.exe"/>
				<include name="FilterModuleParameter/bin/FilterModuleParameter.FilterModuleParameter.exe"/>
				<include name="Wedding/bin/wedding.Wedding.exe"/>
				-->
				
				<!-- correct.txt less tests -->
				
				<!-- working as it should -->
				<include name="SecretAOSDExample/bin/SecretAOSDExample.MainRunner.exe"/>
				<include name="Platypus/bin/PlatypusExample.Main.exe"/>
				<include name="VenusFlyTrap/bin/VenusFlyTrapExample.LivingBeing.exe"/>				
				
				<include name="DesignPatterns/Implementations/Adapter/bin/Composestar.Patterns.Adapter.Main.exe"/>
				<include name="DesignPatterns/Implementations/Builder/bin/Composestar.Patterns.Builder.Main.exe"/>
				<include name="DesignPatterns/Implementations/Decorator/bin/Composestar.Patterns.Decorator.Main.exe"/>
				<include name="DesignPatterns/Implementations/Facade/bin/Composestar.Patterns.Facade.Main.exe"/>
				<include name="DesignPatterns/Implementations/Interpreter/bin/Composestar.Patterns.Interpreter.Main.exe"/>
				<include name="DesignPatterns/Implementations/Iterator/bin/Composestar.Patterns.Iterator.Main.exe"/>
				<include name="DesignPatterns/Implementations/Memento/bin/Composestar.Patterns.Memento.Main.exe"/>
				<include name="DesignPatterns/Implementations/Prototype/bin/Composestar.Patterns.Prototype.Main.exe"/>
				<include name="DesignPatterns/Implementations/Proxy/bin/Composestar.Patterns.Proxy.Main.exe"/>
				<include name="DesignPatterns/Implementations/TemplateMethod/bin/Composestar.Patterns.TemplateMethod.Main.exe"/>
				<include name="DesignPatterns/Implementations/Visitor/bin/Composestar.Patterns.Visitor.Main.exe"/>
				
				<include name="TestCases/GrammarTest/bin/GrammarTest.Class1.exe"/>
				<include name="TestCases/FilterModuleOrderingConstraints/bin/FilterModuleOrderingConstraints.MainRunner.exe"/>
				<include name="TestCases/BasicTests/bin/BasicTests.MainClass.exe"/>
				<include name="TestCases/ConditionTests/bin/ConditionTests.MainClass.exe"/>
				<include name="TestCases/SECRETTesting/bin/SECRETTesting.MainRunner.exe"/>
				<include name="TestCases/ErrorFilterTest/bin/ErrorFilterTest.MainClass.exe"/>
			</FileSet>
		</cs:test>
	</target>

	<!-- generates VS2005 project files based on the VS2003 versions -->
	
	<target name="test_convert" depends="init_local" if="test.mode.2005">
		<cs:dn_convert xslt="${basedir}/AntSystemTest/genCpsProject.xslt">
			<FileSet dir="${build.dotnet}/Examples">
				<include name="**/*.vjsproj"/>
				<include name="**/*.csproj"/>
				<exclude name="AOSD2006Demo/EncryptionFilter/*"/>
				<exclude name="AOSD2006Demo/ProtocolLib/*"/>
				<exclude name="DesignPatterns/Annotations/*"/>
				<exclude name="Jukebox/jukeboxframe/*"/>
				<exclude name="Rot13/Rot13Filter/*"/>
			</FileSet>
		</cs:dn_convert>
	</target>
	
	<!-- test incremental -->
	<target name="test_incre" depends="init_local" if="test.incremental">
		<echo message="Incremental test run" />
		<subant target="test_comp" inheritRefs="true" />
		<subant target="test_exec" inheritRefs="true" />
	</target>

</project>
