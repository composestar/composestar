<?xml version="1.0" encoding="UTF-8"?>
<project name="ComposeStar/DotNET/Compiletime" default="build">

	<condition property="build.core" value="${basedir}${file.separator}..${file.separator}..${file.separator}Core">
		<and>
			<not>
				<isset property="build.core" />
			</not>
			<available file="${basedir}${file.separator}..${file.separator}..${file.separator}Core${file.separator}common.xml" />
		</and>
	</condition>
	<import file="${build.core}${file.separator}common.xml" />
	
	<echo message="${ant.project.name}" />
	
	<description>
	The Compose* DotNET Compiletime
	</description>

	<target name="clean" depends="init">
		<!--<make target="clean" />-->
		<delete dir="${out.build}" />
		<delete dir="${out.dist}" />
		<delete>
			<fileset dir="src/Composestar/DotNET/DUMMER/CSharpDummyGenerator/Parse">
				<include name="CSharpLexer.cs" />
				<include name="CSharpParser.cs" />
				<include name="CSharpTokenTypes.*" />
				<include name="*.smap" />
			</fileset>
		</delete>
		<delete>
			<fileset dir="src/Composestar/DotNET/DUMMER">
				<include name="JSharpLexer.java" />
				<include name="JSharpRecognizer.java" />
				<include name="JSharpTokenTypes.*" />
				<include name="*.smap" />
			</fileset>
		</delete>
		<delete>
			<fileset dir="src">
				<include name="**/*.class" />
			</fileset>
		</delete>
	</target>
	
	<target name="init_local" depends="init">
		<mkdir dir="${out.build}" />
		<mkdir dir="${out.dist}" />
	</target>
	
	<target name="build" depends="init_local,antlr,compile_java,jar,compile_dotnet">
		<!--<make target="build" />-->
	</target>
	
	<target name="antlr">
		<!--
		<antlr target="src/Composestar/DotNET/DUMMER/CSharpDummyGenerator/Parse/csharp.g" outputdirectory="src/Composestar/DotNET/DUMMER/CSharpDummyGenerator/Parse">
			<classpath refid="lib.dotnet"/>
		</antlr>
		-->
		<exec executable="${basedir}/src/Composestar/DotNET/DUMMER/CSharpDummyGenerator/Parse/antlr-2.7.2.exe" dir="src/Composestar/DotNET/DUMMER/CSharpDummyGenerator/Parse">
			<arg value="csharp.g" />
		</exec>
		<antlr target="src/Composestar/DotNET/DUMMER/grammars/jsharp.g" outputdirectory="src/Composestar/DotNET/DUMMER">
			<classpath refid="lib.dotnet"/>
		</antlr>
	</target>
	
	<target name="compile_java">
		<javac srcdir="src" destdir="${out.build}" classpathref="lib.dotnet" source="1.4" target="1.4" debug="${build.debug}">
			<exclude name="**/AssemblyInfo.java" />
		</javac>
	</target>
			
	<target name="compile_dotnet">
		<csc targettype="exe" debug="false" srcdir="src\Composestar\DotNET\ACTING\" destfile="${out.dist}${file.separator}AttributeHarvester.exe" />
		<csc targettype="exe" debug="false" srcdir="src\Composestar\DotNET\TYM\TypeHarvester\" destfile="${out.dist}${file.separator}TypeHarvester.exe" />
		<antcall target="compile_dotnet_devenv" />
	</target>
	
	<target name="compile_dotnet_devenv" if="available.devenv">
		<devenv solution="${basedir}\src\Composestar\DotNET\DUMMER\CSharpDummyGenerator\CSharpDummyGenerator.sln" />
		<copy file="src/Composestar/DotNET/DUMMER/CSharpDummyGenerator/CSharpDummyGenerator.exe" todir="${out.dist}" />
		<copy file="src/Composestar/DotNET/DUMMER/CSharpDummyGenerator/antlr.runtime.dll" todir="${out.dist}" />
		<devenv solution="${basedir}\src\Composestar\DotNET\ILICIT\Weaver\Weavers.sln" />
		<copy todir="${out.dist}">
			<fileset dir="src/Composestar/DotNET/ILICIT/Weaver/bin/Release">
				<include name="IlWeaver.exe" />
				<include name="PeWeaver.exe" />
				<include name="WeaveLibrary.dll" />
			</fileset>
		</copy>
	</target>
	
	<target name="jar">
		<jar destfile="${out.jar.dotnet}" basedir="${out.build}" manifest="src/MANIFEST.MF" />
	</target>
	
	<target name="install" depends="build">
		<copy todir="${composestar.installdir}${file.separator}Binaries">
			<fileset dir="${out.dist}" />
		</copy>
	</target>

</project>