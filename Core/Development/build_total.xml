<?xml version="1.0" encoding="UTF-8"?>
<project name="ComposeStar" default="build">

	<import file="..${file.separator}common.xml" />	
	
	<description>
	Compose* - General build script
	</description>
	
	<!-- clean tasks -->
	
	<target name="clean" depends="init" description="Cleanup compilation results">
		<ant target="clean" dir="${build.core}" />
		<antcall target="clean_dotnet" />
		<antcall target="clean_starlight" />
		<antcall target="clean_java" />
		<antcall target="clean_c" />
	</target>
	
	<target name="clean_dotnet" if="available.dotnet">
		<ant target="clean" dir="${build.dotnet}" />
	</target>
	
		<target name="clean_starlight" if="available.starlight" unless="ignore.starlight">
		<ant target="clean" dir="${build.starlight}" />
	</target>
	
	<target name="clean_java" if="available.java" unless="ignore.java">
		<ant target="clean" dir="${build.java}" />
	</target>
	
	<target name="clean_c" if="available.c" unless="ignore.c">
		<ant target="clean" dir="${build.c}" />
	</target>
	
	<!-- build tasks -->
	
	<target name="core" depends="init" description="Compile the Core of Compose*">
		<ant target="build" dir="${build.core}" />
	</target>
	
	<target name="dotnet" depends="core" if="available.dotnet" description="Compile the .NET port">
		<ant target="build" dir="${build.dotnet}" />
	</target>
	
	<target name="starlight" depends="core" if="available.starlight" unless="ignore.starlight" description="Compile the StarLight port">
		<ant target="build" dir="${build.starlight}" />
	</target>
	
	<target name="java" depends="core" if="available.java" unless="ignore.java">
		<ant target="build" dir="${build.java}" />
	</target>
	
	<target name="c" depends="core" if="available.c" unless="ignore.c">
		<ant target="build" dir="${build.c}" />
	</target>
	
	<target name="build" depends="init,core,dotnet,java,c" description="Compile the whole Compose* project" />
	
	<!-- install tasks -->
	
	<target name="install" depends="init" description="Copy the resulting binaries to the installation directory.">
		<ant target="install" dir="${build.core}" />
		<antcall target="install_dotnet" />
	</target>
	
	<target name="install_dotnet" if="available.dotnet">
		<ant target="install" dir="${build.dotnet}" />
	</target>
	
	<!-- uninstall tasks -->
	
	<target name="uninstall" depends="init" description="Uninstall">
		<!--<ant target="uninstall" dir="${build.core}" />-->
		<antcall target="uninstall_dotnet" />
	</target>
	
	<target name="uninstall_dotnet" if="available.dotnet">
		<ant target="uninstall" dir="${build.dotnet}" />
	</target>
	
	<!-- plugin tasks -->
	
	<target name="plugin" depends="init" description="Compile the IDE plugins">
		<antcall target="plugin_dotnet" />
	</target>
	
	<target name="plugin_dotnet" depends="init" if="available.dotnet">
		<ant target="plugin" dir="${build.dotnet}" />
	</target>
	
	<!-- QA tasks -->
	<target name="qa" depends="findbugs,checkstyle" description="Execute Quality Assurance tasks" />
	
	<!-- execute the findbugs tool -->
	<target name="findbugs" depends="init" description="Analyse the compiled Java code for possible bugs.">
		<antcall target="findbugs_core" />
		<antcall target="findbugs_dotnet" />
	</target>
	
	<target name="findbugs_core" depends="init">
		<ant target="findbugs" dir="${build.core}" />
	</target>
	
	<target name="findbugs_dotnet" depends="init" if="available.dotnet">
		<ant target="findbugs" dir="${build.dotnet}" />
	</target>
	
	<!-- execute the findbugs tool -->
	<target name="checkstyle" depends="init" description="Run CheckStyle source code proof reader.">
		<antcall target="checkstyle_core" />
		<antcall target="checkstyle_dotnet" />
	</target>
	
	<target name="checkstyle_core" depends="init">
		<ant target="checkstyle" dir="${build.core}" />
	</target>
	
	<target name="checkstyle_dotnet" depends="init" if="available.dotnet">
		<ant target="checkstyle" dir="${build.dotnet}" />
	</target>

	<!-- tests -->
	<target name="test" depends="init" description="Execute system tests.">
		<antcall target="test_core" />
		<antcall target="test_dotnet" />
	</target>

	<target name="test_core" depends="init" description="Execute JUnit tests.">
		<ant target="test" dir="${build.core}"/>
	</target>
	
	<target name="test_dotnet" depends="init" if="available.dotnet">
		<ant target="test" dir="${build.dotnet}" />
	</target>
	
	<!-- do everything -->
	<!-- "install" (should) imply "build" -->
	<target name="all" depends="clean,install,test,qa" description="Recompile, install and test the whole system." />	
	<target name="required" depends="clean,install,test" description="Perform the required actions before allowing a commit." />	
	<target name="cleaninstall" depends="clean,install" description="Clean, compile, and then install" />
	
	<target name="nightlybuild" description="Execute the nightly build">
		<tstamp />
		<echo>
========================================================================
                  Compose* Nightly Build - Report

The following in the report of the nightly build of Compose* on:
 ${TODAY}
If the build failed the cause will be listed at the end of the report.
========================================================================
		</echo>
		<antcall target="all" />
	</target>
	
	<!-- task selector -->
	<!-- fancy selection -->	
	<target name="select">	
		<taskdef resource="com/sardak/antform/taskdefs.properties" classpath="${basedir}/Ant/lib/antform.jar" />
		<antmenu image="${basedir}/logo.gif" title="Compose* Build">
		
			<antMenuItem name="Advanced" >
				<antMenuItem name="Clean" target="clean" />		
				<antMenuItem name="Build">
					<antMenuItem name="Build all" target="build" />
					<antMenuItem name="Rebuild all" target="rebuild" />

					<antMenuItem name="Core" target="core" />
					<antMenuItem name="DotNET" target="dotnet" />
					<antMenuItem name="StarLight" target="starlight" />
					<!--<antMenuItem name="Java" target="java" />
					<antMenuItem name="C" target="c" />-->
				</antMenuItem>
				<antMenuItem name="Plugin">
					<antMenuItem name="DotNET" target="plugin_dotnet" />
				</antMenuItem>
				<antMenuItem name="Installation">
					<antMenuItem name="Install" target="install" />
					<antMenuItem name="Uninstall" target="uninstall" />
				</antMenuItem>
				<antMenuItem name="Run tests" target="test" />
				<antMenuItem name="QA">
					<antMenuItem name="All QA targets" target="qa" />
					<antMenuItem name="FindBugs" target="findbugs" />
					<antMenuItem name="CheckStyle" target="checkstyle" />
				</antMenuItem>
			</antMenuItem>
					
			<link label="Rebuild" target="rebuild" />
			<link label="Clean install" target="cleaninstall" />			
			<link label="Clean, build, install &amp; test" target="required" />
			
			<separator />
			
			<link label="Cancel" target="cancel" />
		</antmenu>
	</target>
</project>